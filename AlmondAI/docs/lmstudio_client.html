<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AlmondAI ↔ LM Studio Quick Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 2rem;
      background: #101216;
      color: #e6edf3;
    }
    h1 {
      margin-top: 0;
      font-size: 1.8rem;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
    }
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 0.6rem 0.75rem;
      margin-top: 0.35rem;
      border: 1px solid #384455;
      border-radius: 0.5rem;
      background: #0b0d10;
      color: inherit;
      font-size: 0.95rem;
      font-family: inherit;
    }
    textarea {
      min-height: 8rem;
      resize: vertical;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #6b8bff, #a855f7);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: progress;
    }
    .hint {
      font-size: 0.85rem;
      color: #97a6bc;
      margin-top: 0.35rem;
    }
    pre {
      background: #0b0d10;
      border-radius: 0.5rem;
      padding: 1rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .layout {
      max-width: 840px;
      margin: 0 auto;
    }
    .output {
      margin-top: 2rem;
    }
    .error {
      color: #f97070;
      font-weight: 600;
      margin-top: 1rem;
    }
    a {
      color: #82aaff;
    }
  </style>
</head>
<body>
  <div class="layout">
    <h1>AlmondAI ↔ LM Studio Quick Client</h1>
    <p>This standalone HTML page mirrors the OpenAI-compatible requests that AlmondAI sends
      when <code>chat use lmstudio</code> is active. Open it in a browser on the same machine as LM Studio,
      keep the defaults, and send prompts to confirm the server is reachable.</p>

    <label for="endpoint">Endpoint</label>
    <input id="endpoint" type="text" value="http://127.0.0.1:1234/v1/chat/completions" />
    <p class="hint">Leave the default when LM Studio is running locally with the HTTP server enabled.</p>

    <label for="model">Model</label>
    <input id="model" type="text" value="lmstudio" />

    <label for="system">System prompt (optional)</label>
    <textarea id="system" placeholder="You are AlmondAI's teacher model."></textarea>

    <label for="prompt">User prompt</label>
    <textarea id="prompt" placeholder="Ask LM Studio something..." required></textarea>

    <label for="temperature">Temperature</label>
    <input id="temperature" type="number" min="0" max="2" step="0.1" value="0.2" />
    <p class="hint">LM Studio does not require an API key by default. If you have one configured, add a Bearer token below.</p>

    <label for="apiKey">API key (optional)</label>
    <input id="apiKey" type="text" placeholder="sk-..." />

    <button id="send">Send prompt</button>

    <div id="status" class="hint" aria-live="polite"></div>

    <div class="output" id="output" hidden>
      <h2>Response</h2>
      <pre id="responseText"></pre>
      <details>
        <summary>Raw JSON</summary>
        <pre id="rawJson"></pre>
      </details>
    </div>

    <div id="error" class="error" role="alert"></div>
  </div>

  <script>
    const sendButton = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const outputSection = document.getElementById('output');
    const responseTextEl = document.getElementById('responseText');
    const rawJsonEl = document.getElementById('rawJson');
    const errorEl = document.getElementById('error');

    function buildMessages(system, prompt) {
      const messages = [];
      if (system.trim()) {
        messages.push({ role: 'system', content: system.trim() });
      }
      messages.push({ role: 'user', content: prompt.trim() });
      return messages;
    }

    async function sendPrompt() {
      const endpoint = document.getElementById('endpoint').value.trim();
      const model = document.getElementById('model').value.trim() || 'lmstudio';
      const system = document.getElementById('system').value;
      const prompt = document.getElementById('prompt').value;
      const temperature = parseFloat(document.getElementById('temperature').value) || 0.2;
      const apiKey = document.getElementById('apiKey').value.trim();

      errorEl.textContent = '';
      outputSection.hidden = true;
      statusEl.textContent = '';

      if (!endpoint) {
        errorEl.textContent = 'Endpoint is required.';
        return;
      }
      if (!prompt.trim()) {
        errorEl.textContent = 'Prompt cannot be empty.';
        return;
      }

      sendButton.disabled = true;
      statusEl.textContent = 'Sending request…';

      const headers = { 'Content-Type': 'application/json' };
      if (apiKey) {
        headers['Authorization'] = `Bearer ${apiKey}`;
      }

      const body = {
        model,
        temperature,
        messages: buildMessages(system, prompt)
      };

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers,
          body: JSON.stringify(body)
        });

        const json = await response.json();
        rawJsonEl.textContent = JSON.stringify(json, null, 2);

        const content = json?.choices?.[0]?.message?.content
          || json?.output_text
          || '(no text field returned)';

        responseTextEl.textContent = content;
        outputSection.hidden = false;
        statusEl.textContent = `HTTP ${response.status}`;
      } catch (err) {
        console.error(err);
        errorEl.textContent = err instanceof Error ? err.message : String(err);
        statusEl.textContent = '';
      } finally {
        sendButton.disabled = false;
      }
    }

    sendButton.addEventListener('click', sendPrompt);
    document.addEventListener('keydown', (event) => {
      if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
        event.preventDefault();
        sendPrompt();
      }
    });
  </script>
</body>
</html>
